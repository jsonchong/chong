### TCP 包头格式

<img src="/Users/zhangchongchong/Library/Application Support/typora-user-images/image-20200925161459840.png" alt="image-20200925161459840" style="zoom:50%;" />

首先，**源端口号和目标端口号**是不可少的

接下来是包的序号。为什么要给**包编号**呢？当然是为了解决乱序的问题。不编好号怎么确认哪个应该先来，哪个应该后到呢。编号是为了解决乱序问题。

还应该有的就是**确认序号**。发出去的包应该有确认，要不然我怎么知道对方有没有收到呢？如果没有收到就应该重新发送，直到送达。这个可以解决不丢包的问题。

接下来有一些**状态位。例如 SYN 是发起一个连接，ACK 是回复，RST 是重新连接，FIN 是结束连接**等。TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。

还有一个重要的就是**窗口大小**。TCP 要做流量控制，通信双方各声明一个窗口，标识自己当前能够的处理能力，别发送的太快，撑死我，也别发的太慢，饿死我。

### TCP 的三次握手

我们还是假设这个通路是非常不可靠的，A 要发起一个连接，当发了第一个请求杳无音信的时候，会有很多的可能性，比如第一个请求包丢了，再如没有丢，但是绕了弯路，超时了，还有 B 没有响应，不想和我连接。

A 不能确认结果，B 收到了请求包，就知道了 A 的存在，并且知道 A 要和它建立连接。**如果 B 不乐意建立连接，则 A 会重试一阵后放弃，连接建立失败，没有问题；如果 B 是乐意建立连接的，则会发送应答包给 A**。

当然对于 B 来说，这个应答包也是一入网络深似海，**不知道能不能到达 A。这个时候 B 自然不能认为连接是建立好了**，因为应答包仍然会丢，会绕弯路，或者 A 已经挂了都有可能。

**B 发送的应答可能会发送多次，但是只要一次到达 A，A 就认为连接已经建立了，因为对于 A 来讲，他的消息有去有回**。**A 会给 B 发送应答之应答，而 B 也在等这个消息，才能确认连接的建立，只有等到了这个消息，对于 B 来讲，才算它的消息有去有回。**

当然你可以说 A 比较坏，就是不发数据，建立连接后空着。我们在程序设计的时候，可以要求开启 **keepalive 机制，即使没有真实的数据包，也有探活包。**

<img src="/Users/zhangchongchong/Library/Application Support/typora-user-images/image-20200925162710368.png" alt="image-20200925162710368" style="zoom:50%;" />

### TCP 四次挥手

<img src="/Users/zhangchongchong/Library/Application Support/typora-user-images/image-20200925162959348.png" alt="image-20200925162959348" style="zoom:50%;" />


### 持续交付相关的三个重点

1. 代码静态检查；
2. 破坏性测试；
3. Mock 与回放。

虽然不同编程语言会使用不同的静态检查工具，但这些静态检查工具的工作原理和检查流程很类似

### 为什么需要代码静态检查？

代码静态检查，即静态代码分析，是**指不运行被测代码，仅通过分析或检查源程序的语法、结构、过程、接口等检查程序的正确性，并找出代码中隐藏的错误和缺陷**（比如参数不匹配、有歧义的嵌套语句、错误的递归、非法计算、可能出现的空指针引用等等）。

在软件开发的过程中，静态代码分析往往在动态测试之前进行，同时也可以作为设计动态测试用例的参考。有统计数据证明，在整个软件开发生命周期中，有 70% 左右的代码逻辑设计和编码缺陷属于重复性错误，完全可以通过静态代码分析发现和修复。

### 静态检查工具的优势

主要包括以下三个方面：

1. 帮助软件开发人员自动执行静态代码分析，快速定位代码的隐藏错误和缺陷
2. 帮助软件设计人员更专注于分析和解决代码设计缺陷；
3. 显著减少在代码逐行检查上花费的时间，提高软件可靠性的同时可以降低软件测试成本。

SonarQube 是一款目前比较流行的工具，国内很多互联网公司都选择用它来搭建静态检查的平台。

SonarQube 采用的是 B/S 架构，通过插件形式，可以支持对 Java、C、C++、JavaScript 等二十几种编程语言的代码质量管理与检测。

Sonar 通过客户端插件的方式分析源代码，可以采用 IDE 插件、Sonar-Scanner 插件、Ant 插件和 Maven 插件等，并通过不同的分析机制完成对项目源代码的分析和扫描，然后把分析扫描的结果上传到 Sonar 的数据库，之后就可以通过 Sonar Web 界面管理分析结果。

### 设定科学的检查流程

1. 鼓励开发人员在开发环境（不管是 IDE 还是编辑器加命令行）下执行静态检查；
2. 不管采用的是主干开发还是特性分支开发的分支策略，都尽可能地在代码合入主干之前，通过静态检查；
3. 没有通过静态检查的产品包，不允许发布到线上或用户验证环境。

<img src="/Users/zhangchongchong/Library/Application Support/typora-user-images/image-20200727175137303.png" alt="image-20200727175137303" style="zoom:50%;" />

其中，S2 和 S3 这两个环节，我们可以借助持续交付系统进行强制检查来完成。

> 公司或团队通常会有一个公共检查规则的最小集合（简称 Rules），不管哪个步骤的检查，至少得保证通过这个最小集合的检查。如果采用 SonarQube 作为静态检查的管理平台，那么可以把这个 Rules 配置为一个 Profile。利用这样一个机制，你可以很方便地管理规则配置

虽然，目前 SonarLint 还不能完全替代 FindBugs、PMD 和 Checkstyle 这三个最常用的静态检查工具，但是我们可以预见，类似 SonarLint 这样的 IDE 插件，在开发人员群体中是颇受欢迎的。你只需安装一个插件就能涵盖所有的静态检查规则，而且可以毫不费力地实时获取公司统一的检查标准。

### 跳过检查的几类方式

为持续交付体系搭建好静态检查服务并设置好 Rules 后，你千万不要认为事情结束了，直接等着看检查结果就行了。因为，通常还会有问题发生：

静态检查时不该报错的地方却报错了，不该报严重问题的地方却报了严重问题。

针对这个共性问题的处理策略，可以分为三类：

1. 把某些文件设置为完全不做静态检查；
2. 把某些文件内部的某些类或方法设置为不做某些规则的检查；
3. 调整规则的严重级别，让规则适应语言的多个版本。

### 如何提高静态检查的效率？

- 其一，能够缩短代码扫描所消耗的时间，从而提升整个持续交付过程的效率；
- 其二，我们通常会采用异步的方式进行静态检查，如果这个过程耗时特别长的话，会让用户产生困惑，从而质疑执行静态检查的必要性。

**除了提升静态检查平台的处理能力外，在代码合入主干前采用增量形式的静态检查**，也可以提升整个静态检查的效率。增量静态检查，是指只对本次合入涉及的文件做检查，而不用对整个工程做全量检查。

### 如何制定规则？

1. 从已有的规则集合中挑选团队适用的规则，必要情况下调整规则的严重等级和部分参数
2. 基于某个规则框架，编写全新的规则。这种方式需要自行编码，难度成本较大，所以我一般不推荐你采用，确实找不到现成的规则时再采用这种方案。

### Sonar 代码静态检查实例

第一步：搭建 Sonar 服务，安装 CheckStyle 等插件。

<img src="https://static001.geekbang.org/resource/image/46/71/46547bc859cdd27115d4d7b4d1de7071.png" alt="img" style="zoom:50%;" />

第二步：设置统一的 Java 检查规则。

在 IDE 中安装 SonarLint 插件后，就可以使用 SonarSource 的自带规则了。

<img src="https://static001.geekbang.org/resource/image/94/34/943983a416e2b3e651bebd097cf09634.png" alt="img" style="zoom:50%;" />

在 GitLab 的 Merge Request 中增加 Sonar 静态检查的环节，包括检查状态和结果等。

![img](https://static001.geekbang.org/resource/image/8d/ca/8dae6234f5003bee410fca4ae9dfb3ca.png)











